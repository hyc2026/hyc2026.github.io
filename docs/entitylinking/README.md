# å®ä½“é“¾æ¥

## é¡¹ç›®èƒŒæ™¯

ç°æœ‰ä¸šåŠ¡çš„æ¨¡å‹æ˜¯ä¸€ä¸ªåœ¨å¤šä¸ªä»»åŠ¡ä¸Šfinetuneå¥½çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¸»è¦çš„ä»»åŠ¡åŒ…æ‹¬æŠ½å–çŸ­ç­”æ¡ˆï¼Œæ‘˜è¦é£˜çº¢ç­‰ä»»åŠ¡ã€‚å½“å‰æ¨¡å‹çš„è¾“å…¥ä¸ºä¸€ä¸ª`query`ä»¥åŠä¸€ä¸ª`doc`ï¼Œ`doc`åŒ…æ‹¬å¾…æŸ¥è¯¢æ–‡ç« çš„`title`å’Œ`content`ï¼Œ`content`æ˜¯çŸ­å¥æ„æˆçš„åˆ—è¡¨ï¼Œå°†`[CLS]+query+[SEP]+title+[CLS]+short_sentence1+[CLS]+short_sentence2+...`ä½œä¸ºæ¨¡å‹è¾“å…¥ï¼Œæ¨¡å‹çš„è¾“å‡ºå†ç»è¿‡ä¸€ç³»åˆ—headï¼Œæœ€ç»ˆè¾¾åˆ°ä¸šåŠ¡æ•ˆæœã€‚

ç›®å‰å¸Œæœ›åœ¨åŸæœ‰ä¸šåŠ¡ä¸å˜çš„åŸºç¡€ä¸Šï¼ŒåŠ å…¥ä¸€ä¸ªå®ä½“é“¾æ¥çš„ä»»åŠ¡ï¼Œå°†æŠ½å–å‡ºçš„çŸ­ç­”æ¡ˆ(mention)å’Œå®ä½“åº“ä¸­çš„å®ä½“è¿›è¡Œé…å¯¹ã€‚æ¯”å¦‚ï¼š

"query": "åéƒ¨å…¬è®¤æœ€å¥½çœ‹æ—¥æœ¬ç”µå½±"

"title": "å²›å›½æœ€éš¾ä»¥ç£¨ç­çš„10éƒ¨ç”µå½±ä½³ä½œ"

"doc": "å²›å›½â€¬ä½œä¸ºäºšæ´²ç”µå½±çš„å…ˆé”‹â€¬ï¼Œæ— è®ºä»èµ·æ­¥è¿˜æ˜¯å½±å“åŠ›éƒ½æ˜¯é†’ç›®â€¬çš„å­˜åœ¨ã€‚äºŒæˆ˜ä¹‹å‰ï¼Œæ—¥æœ¬çš„ç”µå½±å·¥ä¸šå·²ç»éå¸¸å®Œå¤‡ï¼Œæˆ˜ååˆ™å¼€å§‹å¤§å¸ˆæ¶Œç°ï¼Œè¯ç”Ÿæ— æ•°æ°ä½œã€‚â€¬ã€Šç½—ç”Ÿé—¨ã€‹é»‘æ³½æ˜â€¬æ’’è°æ˜¯äººä¹‹æœ¬æ€§ï¼Œåœ¨å¤§å¤šæ•°æ—¶é—´é‡Œæˆ‘ä»¬ç”šè‡³éƒ½ä¸èƒ½å¯¹è‡ªå·±è¯šå®ï¼Œä½†é‚£æ˜¯å› ä¸ºäººä»¬å¤ªè„†å¼±äº†ï¼Œæ‰€ä»¥æ‰æ’’è°ï¼Œç”šè‡³å¯¹è‡ªå·±æ’’è°ã€‚æˆ‘ç”šè‡³å¬è¯´è¿‡å¾€åœ¨ç½—ç”Ÿé—¨è¿™å„¿çš„é¬¼ï¼Œå› ä¸ºå®³æ€•äººç±»çš„å‡¶æ®‹è€Œé€ƒèµ°ã€‚ã€Šæƒ…ä¹¦ã€‹å²©äº•ä¿ŠäºŒâ€œå½“å²æœˆæµé€ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½æ¶ˆå¤±æ®†å°½çš„æ—¶å€™ï¼Œå”¯æœ‰ç©ºä¸­é£˜è¡çš„æ°”å‘³è¿˜æ‹æ‹ä¸æ•£ï¼Œè®©å¾€äº‹å†å†åœ¨ç›®ã€‚â€ã€Šæ— äººçŸ¥æ™“ã€‹æ˜¯æè£•å’Œæ²¡æœ‰å“­å–Šæ²¡æœ‰å¤§ç¬‘æ²¡æœ‰â€¬æ„¤æ€’â€¬ï¼Œå´æœ‰ç€åˆºéª¨çš„å†°å†·â€¦è¿™æ˜¯äººä¸–çš„ç‚å‡‰ä¸æ— å¥ˆã€‚æ— äººçŸ¥æ™“è¿™å››ä¸ªå­©å­çš„ç”Ÿæ´»çš„çª˜å¢ƒï¼Œå°±åƒæ— äººçŸ¥æ™“é‚£ç²‰è‰²è¡Œæç®±ä¸­çš„å°¸ä½“ä¸€æ ·â€¦ã€Š**å…¥æ®“å¸ˆ**ã€‹æ³·ç”°æ´‹äºŒéƒå‘æ­»â€¬è€Œâ€¬ç”Ÿâ€¬ï¼Œå­¦ä¼šâ€¬å‘Šåˆ«â€¬ã€‚æ­»äº¡ä¸è¿‡æ˜¯ä¸€æ‰‡é—¨ï¼Œè®©æˆ‘ä»¬èµ°å‘ä¸€æ®µå´­æ–°çš„æ—…é€”ã€‚å½“é€è€…å®‰æ¯ï¼Œå½“ç”Ÿè€…åšå¼ºï¼Œå½“é‡Šæ€€çš„çˆ±ç•™åœ¨å¿ƒé‡Œï¼Œç‰‡åˆ»å³æ°¸æ’ï¼Œä¸‡ç‰©ä¹Ÿè®¸å°±è¿™æ ·ç”Ÿç”Ÿä¸æ¯..."

entity_info: [

â€‹	"ğŸ•ºå…¥æ®“å¸ˆğŸ©ä¹¦ç±ğŸ“2010å¹´æ—¥æœ¬ç™¾æ¿‘å¿æ‰€è‘—å°è¯´ğŸç”µå½±ã€Šå…¥æ®“å¸ˆã€‹çš„åŒåå°è¯´ã€Šå…¥æ®“å¸ˆã€‹åœ¨æ—¥æœ¬ç”±è‘—åçš„å‡ºç‰ˆç¤¾å°å­¦é¦†å‡ºç‰ˆã€‚ä¸­æ–‡å°è¯´ã€Šå…¥æ®“å¸ˆã€‹ç”±åŒ—äº¬çš„ä¸œæ–¹å‡ºç‰ˆç¤¾å¼•è¿›ï¼Œå¹¶äº2010å¹´4æœˆå‡ºç‰ˆã€‚ğŸš„å½¤å½«,ä¸œæ–¹å‡ºç‰ˆç¤¾",

â€‹	"ğŸ•ºå…¥æ®“å¸ˆğŸ©èŒä¸šğŸ“ä¸ºæ­»è€…è¿˜åŸæœªæ­»ä¹‹çŠ¶æ€çš„äººå‘˜ğŸå…¥æ®“å¸ˆåˆå«åšè‘¬ä»ªå¸ˆï¼Œä¸ºæ­»è€…è¿˜åŸæœªæ­»ä¹‹çŠ¶æ€ã€‚æ•´ä¿®é¢å®¹å’Œèº«ä½“ï¼Œå°½å¯èƒ½è¿˜åŸå®Œæ•´é¢å®¹å’Œèº«ä½“ã€‚ä¹Ÿå¯å«åšä¸ºæ­»è€…åŒ–å¦†æ•´ä»ªï¼Œçº³å…¥æ£ºä¸­çš„èŒä¸šã€‚ä¸»è¦å‡ºç°åœ¨æ—¥æœ¬ï¼Œåè¿›å…¥ä¸­å›½ã€‚è®©å·²ç»å†°å†·çš„äººé‡ç„•ç”Ÿæœºï¼Œç»™å¥¹æ°¸æ’çš„ç¾ä¸½ï¼›è¿˜è¦æœ‰å†·é™å‡†ç¡®ï¼Œå¹¶ä¸”æ€€ç€æ¸©æŸ”çš„æƒ…æ„Ÿã€‚ğŸš„è‘¬ä»ªå¸ˆ,ç”¨æ€èŒçš‚æ¸…æ´—å°¸ä½“,departures",

â€‹	"ğŸ•ºå…¥æ®“å¸ˆğŸ©ç”µå½±ğŸ“æ³·ç”°æ´‹äºŒéƒæ‰§å¯¼ç”µå½±ğŸã€Šå…¥æ®“å¸ˆã€‹æ˜¯æ ¹æ®æ—¥æœ¬ä½œå®¶é’æœ¨æ–°é—¨çš„å°è¯´ã€Šé—¨çº³æ£ºå¤«æ—¥è®°ã€‹æ”¹ç¼–è€Œæˆï¼Œç”±æ³·ç”°æ´‹äºŒéƒæ‰§å¯¼ï¼Œæœ¬æœ¨é›…å¼˜ã€å±±å´åŠªã€å¹¿æœ«å‡‰å­ã€å‰è¡Œå’Œå­å’Œç¬¹é‡é«˜å²ç­‰è”è¢‚å‡ºæ¼”ã€‚å½±ç‰‡è®²è¿°äº†æ—¥æœ¬å…¥æ®“å¸ˆçš„ç”Ÿæ´»ï¼Œå½±ç‰‡ä»¥ä¸€åå…¥æ®“å¸ˆğŸš„å½©è‰²,å‰§æƒ…ï¼ŒéŸ³ä¹,çºªå½•ç‰‡,ä¸ºé€è€…é€è¡Œçš„äºº,ä¸­æ³½æ•æ˜,ç¬¹é‡é«˜å²,æµœç”°æ¯…,å‰§æƒ…,å±±å´åŠª,å¹¿æœ«å‡‰å­,Okuribito,å°è¶Šå‹‡è¾‰,å®«ç”°æ—©è‹—,é©å‘½,é€è¡Œè€…-ç¤¼ä»ªå¸ˆçš„ä¹ç« ,å°æ—ç¾é¦™,æ—¥è¯­",

â€‹	"ğŸ•ºå…¥æ®“å¸ˆğŸ©è™šæ‹Ÿè§’è‰²ğŸ“ã€Šé˜´é˜³å¸ˆã€‹ä¸­çš„å¼ç¥,ç½‘æ˜“æ‰‹æ¸¸ã€Šé˜´é˜³å¸ˆã€‹ä¸­çš„SRå¼ç¥ä¹‹ä¸€ğŸå…¥æ®“å¸ˆï¼Œç½‘æ˜“æ‰‹æ¸¸ã€Šé˜´é˜³å¸ˆã€‹ä¸­çš„SRå¼ç¥ä¹‹ä¸€ã€‚åˆç§°è‘¬ä»ªå¸ˆï¼Œä¸ºé€è€…è¿˜åŸæœªæ­»ä¹‹çŠ¶æ€ï¼Œæ•´ä¿®é¢å®¹å’Œèº«ä½“ï¼Œå°½å¯èƒ½è¿˜åŸå®Œæ•´é¢å®¹å’Œèº«ä½“çš„ç”·å­ã€‚ğŸš„ç”·,æŠ½ç¬¦,ç¢ç‰‡åˆæˆ,Okuribito,æ§åˆ¶,è¾“å‡º,ãŠãã‚Šã³ã¨,ç»‡é›ª,è‘¬ä»ªå¸ˆ,æŠ½ç¬¦ã€ç¢ç‰‡åˆæˆ,é€Ÿæ°´å¥–",

â€‹	"ğŸ•ºå…¥æ®“å¸ˆğŸ©å°è¯´ğŸ“2016å¹´åˆ˜ä¸œè¥¿åˆ›ä½œçš„ç½‘ç»œå°è¯´ğŸæˆ‘æ˜¯ä¸€åå…¥æ®“å¸ˆï¼Œä¸€å¤©æ™šä¸Šï¼Œå°±åœ¨æˆ‘å’Œå¥³åŒäº‹åœ¨åœå°¸é—´è¿›è¡Œä¸å¯æè¿°çš„äº‹æƒ…ä¹‹åï¼Œä¸€å…·å°¸ä½“è«åå…¶å¦™çš„æ¶ˆå¤±äº†â€¦â€¦ğŸš„rulianshi,å·¨åŒ é˜…è¯»ç½‘",

]

ä½¿ç”¨åŒå¡”æ¨¡å‹ï¼Œå°†è¾“å…¥åˆ†åˆ«ä¸åŒ¹é…ä¸Šçš„entityè¿›è¡Œé…å¯¹ï¼Œçš„åˆ†æœ€é«˜çš„å³ä¸ºé“¾æ¥ä¸Šçš„å®ä½“



![twotower](twotower.png)

## ç°æœ‰åšæ³•

1. ä¸ºäº†ä¸å½±å“åŸæœ‰æ¨¡å‹çš„æ•ˆæœï¼Œå°†docçš„ä¾§çš„æ¨¡å‹freezeä½ï¼Œä¸æ›´æ–°å‚æ•°ï¼Œç”¨å®ä½“é“¾æ¥çš„è®­ç»ƒé›†è®­ç»ƒentity infoæ¨¡å‹
2. ä¸freezeä½ä¸¤ä¸ªæ¨¡å‹ï¼Œè®­ç»ƒå‡ºä¸€ä¸ªteacher modelï¼Œå’Œä¹‹å‰ä¸šåŠ¡ä¸Šçš„å…¶ä»–æ¨¡å‹ä¸€èµ·è’¸é¦ã€‚
3. è¿™ä¸¤ç§åšæ³•ç»“æŸä¹‹åéƒ½éœ€è¦å°†entity infoä¾§çš„æ‰€æœ‰å®ä½“çš„embeddingè¾“å‡ºæˆtensorå­˜åœ¨æ˜¾å­˜ä¸­ï¼Œå› æ­¤éœ€è¦å°†768ç»´çš„å‘é‡é™ç»´æˆ128ç»´ï¼Œä½¿ç”¨pca åˆå§‹åŒ–é™ç»´çŸ©é˜µå¯ä»¥å¯¹å¢¨é¦™æ•ˆæœæœ‰å¾ˆå¤§çš„æé«˜

```python
import numpy as np
from sklearn.datasets._samples_generator import make_blobs
from sklearn.decomposition import PCA
import torch

# tensor å’Œ ndarry çš„ç›¸äº’è½¬åŒ–
# A = X.numpy() # tensor->ndarray
# B = torch.tensor(A) # ndarray->tensor

dim = 512
tensor = torch.cat((torch.load('0.th', map_location=torch.device('cpu')), torch.load('1.th', map_location=torch.device('cpu'))), dim=0) # [20000, 768]
X = tensor.numpy()
pca = PCA(n_components=dim)
pca.fit(X)
comp = pca.components_
B = torch.tensor(comp)
torch.save(B, 'pca_{}.th'.format(str(dim)))

# test
# X, _ = make_blobs(n_samples=10, n_features=8, random_state =9) # ç”Ÿæˆ10æ¡8ç»´çš„æ•°æ®
# print(X.shape)
# pca = PCA(n_components=4) # å°†8ç»´é™åˆ°4ç»´
# X_transformed1 = pca.fit(X).transform(X) # pca.fit(X)-è®­ç»ƒ + pca.transform(X)-å°†æ•°æ®Xè½¬æ¢æˆé™ç»´åçš„æ•°æ®
# comp = pca.components_ # (n_components, n_features) è½¬æ¢çŸ©é˜µ
# print(comp.shape)
# X_M = X - X.mean(axis=0)
# X_transformed2 = np.dot(X_M, comp.T) # å’ŒX_transformed1æ•°å€¼ç›¸åŒ
```

